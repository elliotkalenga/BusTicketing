@{
    Layout = "_AuthLayout";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Login - Bus Ticketing System</title>

    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />

    <style>
        body {
            background: url('/images/BGTT.jpg') no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: "Century Gothic", CenturyGothic, AppleGothic, "Segoe UI", Roboto, sans-serif;
            position: relative;
        }

            body::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(13, 27, 42, 0.5);
                z-index: 0;
            }

        .login-card {
            position: relative;
            z-index: 1;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 0 25px rgba(0,0,0,0.4);
            background-color: #ffffffdd;
            width: 100%;
            max-width: 400px;
        }

        :root {
            --navy: #0b2c4d;
            --gold: #d4af37;
            --light-bg: #f8f9fa;
        }
        .login-header {
            background: #0b2c4d;
            color: #d4af37;
            text-align: center;
            padding: 2rem 1rem;
        }

            .login-header h4 {
                margin-bottom: 0.5rem;
                font-weight: bold;
            }

        .login-body {
            padding: 2rem 1.5rem;
        }

        .btn-login {
            background-color: #0d1b2a;
            color: #d4af37;
            font-weight: bold;
        }

            .btn-login:hover {
                background-color: #d4af37;
                color: #0d1b2a;
            }

        .btn-darkblue {
            background-color: #0d1b2a !important;
            color: #d4af37 !important;
            border: none;
        }

            .btn-darkblue:hover {
                opacity: 0.85;
            }

        .input-group-text {
            background-color: #0d1b2a;
            color: #d4af37;
            border: none;
        }

        .modal-header {
            background-color: #0d1b2a;
            color: #d4af37;
            border-bottom: none;
        }

        #resetMsg.success {
            color: green;
        }

        #resetMsg.error {
            color: red;
        }

        /* Network overlay canvas */
        .network-overlay {
            position: fixed; /* covers viewport */
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1; /* above body::before (0), below login card */
            pointer-events: none; /* don't block clicks */
        }

        /* Ensure the card is above the overlay */
        .login-card {
            z-index: 2; /* was 1; raise above canvas */
        }

    </style>
</head>

<body>

    <canvas id="networkCanvas" class="network-overlay"></canvas>

    <!-- LOGIN CARD -->
    <div class="login-card card shadow-lg">
        <div class="login-header">

            <h4 class="d-flex justify-content-center align-items-center">
                <i class="bi bi-bus-front-fill me-2"></i> Bus Ticketing System
            </h4>

            <div class="text-center text-white mt-2">
                Please login to start your session
            </div>
        </div>

        <div class="login-body">
            @if (ViewBag.Error != null)
            {
                <div class="alert alert-danger">@ViewBag.Error</div>
            }

            <form method="post" class="needs-validation" novalidate>
                <div class="mb-3">
                    <label for="username">Username</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-person-fill"></i></span>
                        <input name="username" id="username" class="form-control" placeholder="Enter username" required />
                    </div>
                </div>

                <div class="mb-3">
                    <label for="password">Password</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-lock-fill"></i></span>
                        <input name="password" id="password" type="password" class="form-control" placeholder="Enter password" required />
                    </div>
                </div>

                <button type="submit" class="btn btn-login w-100 mb-3">Login</button>

                <div class="text-center">
                    <a href="#" data-bs-toggle="modal" data-bs-target="#resetModal">Forgot Password?</a>
                </div>
            </form>
        </div>
    </div>

    <!-- RESET PASSWORD MODAL -->
    <div class="modal fade" id="resetModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-shield-lock me-2"></i>Reset Password</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <!-- STEP 1 -->
                    <div id="stepPhone">
                        <label><i class="bi bi-telephone-fill me-1"></i>Phone number</label>
                        <input id="resetPhone" class="form-control" placeholder="265XXXXXXXXX" />

                        <button class="btn btn-darkblue w-100 mt-3" id="btnSendOtp">
                            <i class="bi bi-send-fill me-1"></i>Send Verification Code
                        </button>
                    </div>

                    <!-- STEP 2 -->
                    <div id="stepOtp" style="display:none;">
                        <label><i class="bi bi-key-fill me-1"></i>Enter OTP</label>
                        <input id="resetOtp" class="form-control" placeholder="Enter the code sent to your phone" />

                        <button class="btn btn-warning w-100 mt-3" id="btnVerifyOtp">
                            <i class="bi bi-check-circle-fill me-1"></i>Verify Code
                        </button>
                    </div>

                    <!-- STEP 3 -->
                    <div id="stepNewPass" style="display:none;">
                        <label><i class="bi bi-lock-fill me-1"></i>New Password</label>
                        <input id="newPass" type="password" class="form-control" placeholder="Enter new password" />

                        <label class="mt-2"><i class="bi bi-lock-fill me-1"></i>Confirm Password</label>
                        <input id="confirmPass" type="password" class="form-control" placeholder="Confirm new password" />

                        <button class="btn btn-success w-100 mt-3" id="btnSavePass">
                            <i class="bi bi-save-fill me-1"></i>Save New Password
                        </button>
                    </div>

                    <div id="resetMsg" class="mt-3 text-center fw-bold"></div>

                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let tempPhone = "";

        const msgBox = document.getElementById("resetMsg");

        // Clear OTP session when modal closes
        const modalEl = document.getElementById('resetModal');
        modalEl.addEventListener('hidden.bs.modal', function () {
            fetch("/Login/ClearOtpSession", { method: "POST" });
        });

        function setMessage(message, success) {
            msgBox.innerHTML = message;
            msgBox.className = success ? "success fw-bold mt-3" : "error fw-bold mt-3";
        }

        document.getElementById("btnSendOtp").onclick = function (e) {
            e.preventDefault();
            tempPhone = document.getElementById("resetPhone").value;

            fetch("/Login/SendOtp", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ phone: tempPhone })
            })
                .then(r => r.json())
                .then(res => {
                    setMessage(res.message, res.success);

                    if (res.success) {
                        document.getElementById("stepPhone").style.display = "none";
                        document.getElementById("stepOtp").style.display = "block";
                    }
                });
        };

        document.getElementById("btnVerifyOtp").onclick = function (e) {
            e.preventDefault();
            let otp = document.getElementById("resetOtp").value;

            fetch("/Login/VerifyOtp", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ phone: tempPhone, otp })
            })
                .then(r => r.json())
                .then(res => {
                    setMessage(res.message, res.success);

                    if (res.success) {
                        document.getElementById("stepOtp").style.display = "none";
                        document.getElementById("stepNewPass").style.display = "block";
                    }
                });
        };

        document.getElementById("btnSavePass").onclick = function (e) {
            e.preventDefault();
            let pass = document.getElementById("newPass").value;
            let conf = document.getElementById("confirmPass").value;

            fetch("/Login/SaveNewPassword", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ phone: tempPhone, pass, conf })
            })
                .then(r => r.json())
                .then(res => {
                    setMessage(res.message, res.success);

                    if (res.success) {
                        setTimeout(() => {
                            bootstrap.Modal.getInstance(modalEl).hide();
                            location.reload();
                        }, 10000); // 10 seconds
                    }
                });
        };


        (() => {
          // Respect accessibility: render static if user prefers reduced motion
          const reduceMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

          const canvas = document.getElementById('networkCanvas');
          const ctx = canvas.getContext('2d');

          // Theme colors
          const COLOR_NODE = '#c9a52f';                // gold nodes
          const COLOR_LINK = 'rgba(11, 44, 77, 0.65)'; // dark blue links
          const BG_TINT   = 'rgba(11, 44, 77, 0.1)';   // optional faint blue background tint

          let DPR = Math.max(1, Math.floor(window.devicePixelRatio || 1));
          let W = 0, H = 0;

          // Node config
          const SPEED_MIN = 0.05, SPEED_MAX = 0.25;
          const LINK_DIST = 140;
          const NODE_RADIUS_MIN = 2.0, NODE_RADIUS_MAX = 4.0;

          function nodeCountForArea(width, height) {
            const density = 0.00010;
            return Math.max(40, Math.min(160, Math.round(width * height * density)));
          }

          const mouse = { x: null, y: null };
          window.addEventListener('mousemove', e => {
            mouse.x = e.clientX;
            mouse.y = e.clientY;
          }, { passive: true });
          window.addEventListener('mouseleave', () => {
            mouse.x = mouse.y = null;
          });

          let nodes = [];
          let rafId = null;

          function resize() {
            W = canvas.clientWidth = window.innerWidth;
            H = canvas.clientHeight = window.innerHeight;

            canvas.width = W * DPR;
            canvas.height = H * DPR;
            ctx.setTransform(DPR, 0, 0, DPR, 0, 0);

            const targetCount = nodeCountForArea(W, H);
            nodes = Array.from({ length: targetCount }, () => makeNode());
          }

          function rand(min, max) { return Math.random() * (max - min) + min; }
          function makeNode() {
            const vx = rand(-SPEED_MAX, SPEED_MAX);
            const vy = rand(-SPEED_MAX, SPEED_MAX);
            return {
              x: rand(0, W), y: rand(0, H),
              vx: (Math.abs(vx) < SPEED_MIN ? Math.sign(vx || 1) * SPEED_MIN : vx),
              vy: (Math.abs(vy) < SPEED_MIN ? Math.sign(vy || 1) * SPEED_MIN : vy),
              r: rand(NODE_RADIUS_MIN, NODE_RADIUS_MAX)
            };
          }

          function step() {
            ctx.clearRect(0, 0, W, H);

            // Move nodes
            for (const n of nodes) {
              if (mouse.x != null && mouse.y != null) {
                const dx = mouse.x - n.x, dy = mouse.y - n.y;
                const dist = Math.hypot(dx, dy);
                if (dist < 220) {
                  n.vx += (dx / dist) * 0.005;
                  n.vy += (dy / dist) * 0.005;
                }
              }

              n.x += n.vx;
              n.y += n.vy;

              if (n.x < 0 || n.x > W) n.vx *= -1;
              if (n.y < 0 || n.y > H) n.vy *= -1;
              n.x = Math.max(0, Math.min(W, n.x));
              n.y = Math.max(0, Math.min(H, n.y));
            }

            // Draw links
            for (let i = 0; i < nodes.length; i++) {
              for (let j = i + 1; j < nodes.length; j++) {
                const a = nodes[i], b = nodes[j];
                const dx = a.x - b.x, dy = a.y - b.y;
                const d = Math.hypot(dx, dy);
                if (d < LINK_DIST) {
                  const alpha = 1 - (d / LINK_DIST);
                  ctx.strokeStyle = `rgba(11, 44, 77, ${0.25 + alpha * 0.35})`;
                  ctx.lineWidth = 1.2;
                  ctx.beginPath();
                  ctx.moveTo(a.x, a.y);
                  ctx.lineTo(b.x, b.y);
                  ctx.stroke();
                }
              }
            }

            // Draw nodes
            for (const n of nodes) {
              ctx.fillStyle = COLOR_NODE;
              ctx.beginPath();
              ctx.arc(n.x, n.y, n.r, 0, Math.PI * 2);
              ctx.fill();
            }

            rafId = requestAnimationFrame(step);
          }

          function start() {
            resize();
            if (reduceMotion) {
              step();
              cancelAnimationFrame(rafId);
            } else {
              step();
            }
          }

          window.addEventListener('resize', () => {
            cancelAnimationFrame(rafId);
            start();
          });

          start();
        })();

    </script>

</body>
</html>
