@model List<BusTicketing.ViewModels.TownFormVm>

@{
    Layout = null;
    var provinces = ViewBag.Provinces as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
}

<div class="container-fluid mt-2">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="m-0">
            <i class="bi bi-geo-alt-fill me-2"></i> Towns
        </h4>
        <!-- Add Town button -->
        <button class="btn btn-dark-blue" id="addTownBtn">
            <i class="bi bi-plus-circle me-1"></i> Add Town
        </button>
    </div>

    <table id="townTable" class="table table-striped table-bordered w-100">
        <thead>
            <tr>
                <th>Town</th>
                <th>Province</th>
                <th style="width:160px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var t in Model ?? Enumerable.Empty<BusTicketing.ViewModels.TownFormVm>())
            {
                <tr>
                    <td>@t.Name</td>
                    <td>@t.ProvinceName</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-warning edit-btn"
                                data-id="@t.Id"
                                data-name="@t.Name"
                                data-province="@t.ProvinceId">
                            <i class="bi bi-pencil"></i>
                        </button>

                        <form method="post" asp-action="Delete" asp-controller="Towns" class="d-inline"
                              onsubmit="return confirm('Delete this town?');">
                            <input type="hidden" name="id" value="@t.Id" />
                            <button type="submit" class="btn btn-sm btn-danger">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- MODAL -->
<div class="modal fade" id="townModal" tabindex="-1">
    <div class="modal-dialog">
        <form method="post" asp-action="Save" asp-controller="Towns">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title"><i class="bi bi-geo-alt-fill me-1"></i> Town</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" id="townId" name="Id" />

                    <div class="mb-3">
                        <label class="form-label"><i class="bi bi-signpost-2 me-1"></i> Town Name</label>
                        <input class="form-control" id="townName" name="Name" placeholder="Enter town name" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><i class="bi bi-map me-1"></i> Province</label>
                        <select class="form-select" id="provinceSelect" name="ProvinceId" required>
                            <option value="">-- Select Province --</option>
                            @foreach (var p in provinces)
                            {
                                <option value="@p.Id">@p.Name</option>
                            }
                        </select>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-dark-blue"><i class="bi bi-save me-1"></i> Save</button>
                </div>
            </div>
        </form>
    </div>
</div>
<!-- DataTables Buttons CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css" />

<!-- DataTables Buttons JS dependencies -->
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Initialize DataTable with export buttons
            $('#townTable').DataTable({
    responsive: true,
    dom: 'Bfrtip',
    buttons: [
        { extend: 'copy', text: '<i class="bi bi-clipboard"></i> Copy' },
        { extend: 'excel', text: '<i class="bi bi-file-earmark-excel"></i> Excel' },
        { extend: 'csv', text: '<i class="bi bi-file-text"></i> CSV' },
        { extend: 'pdf', text: '<i class="bi bi-file-earmark-pdf"></i> PDF' },
        { extend: 'print', text: '<i class="bi bi-printer"></i> Print' }
    ]
});


            // Show modal if TempData triggered it
            if ('@TempData["ShowTownModal"]?.ToString().ToLower()' === 'true') {
                new bootstrap.Modal(document.getElementById('townModal')).show();
            }

            // Add Town button
            $('#addTownBtn').click(function () {
                clearTownForm();
                new bootstrap.Modal(document.getElementById('townModal')).show();
            });

            // Edit Town button
            $('#townTable').on('click', '.edit-btn', function () {
                const btn = $(this);
                $('#townId').val(btn.data('id'));
                $('#townName').val(btn.data('name'));
                $('#provinceSelect').val(btn.data('province'));
                new bootstrap.Modal(document.getElementById('townModal')).show();
            });
        });

        function clearTownForm() {
            $('#townId').val(0);
            $('#townName').val('');
            $('#provinceSelect').val('');
        }
    </script>
}
